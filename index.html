<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Biosphere - Interactive Tour</title>
  <style>
    :root { --bg: #05070a; --ui-bg: rgba(20, 25, 40, 0.9); --accent: #00e5ff; --text: #f0f0f0; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; overflow: hidden; }
    #app { position: fixed; inset: 0; }
    
    /* UI OVERLAY */
    #overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 100; transition: opacity 0.5s ease;
    }
    h1 { font-weight: 300; letter-spacing: 6px; margin: 0 0 10px 0; font-size: 32px; text-transform: uppercase; }
    h1 span { font-weight: 800; color: var(--accent); }
    p { color: #888; font-size: 14px; margin-bottom: 30px; letter-spacing: 1px; }
    
    #startBtn {
      padding: 15px 60px; font-size: 16px; font-weight: 700; letter-spacing: 2px;
      background: transparent; color: var(--accent); border: 2px solid var(--accent); 
      cursor: pointer; text-transform: uppercase; transition: all 0.2s;
    }
    #startBtn:hover { background: var(--accent); color: #000; box-shadow: 0 0 40px var(--accent); }

    /* HUD */
    #hud {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      display: flex; flex-direction: column; align-items: center;
      pointer-events: none; opacity: 0; transition: opacity 1s;
    }
    .hud-controls {
        background: rgba(0,0,0,0.6); padding: 8px 20px; border-radius: 20px;
        backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1);
        font-size: 12px; color: #ccc; margin-bottom: 10px; display: flex; gap: 15px;
    }
    .key { font-weight: bold; color: #fff; border: 1px solid #666; padding: 0 5px; border-radius: 3px; background: rgba(255,255,255,0.1); }
    
    /* PROGRESS BAR */
    #progress-container {
        width: 300px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;
    }
    #progress-bar {
        width: 0%; height: 100%; background: var(--accent); box-shadow: 0 0 10px var(--accent); transition: width 0.1s linear;
    }

  </style>

  <!-- Import Map -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>
</head>

<body>
  <div id="app"></div>

  <div id="overlay">
    <h1>Biosphere<span>Explorer</span></h1>
    <p>INTERACTIVE WALKTHROUGH</p>
    <button id="startBtn">ENTER EXPERIENCE</button>
  </div>

  <div id="hud">
    <div class="hud-controls">
        <span><span class="key">W</span> / <span class="key">S</span> MOVE</span>
        <span><span class="key">A</span> / <span class="key">D</span> TURN</span>
        <span><span class="key">MOUSE</span> LOOK</span>
    </div>
    <div id="progress-container"><div id="progress-bar"></div></div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
    import { load } from 'https://cdn.jsdelivr.net/npm/@loaders.gl/core@4.3.3/+esm';
    import { LASLoader } from 'https://cdn.jsdelivr.net/npm/@loaders.gl/las@4.3.3/+esm';

    // =========================================================================
    // üåç DATA & SETTINGS
    // =========================================================================

    const SETTINGS = {
        // Start Position (End of array logic handles this automatically)
        startPos: new THREE.Vector3(-25.72, 25.83, 0.64),
        startLookAt: new THREE.Vector3(-24.83, 35.57, -1.45),
        
        walkSpeed: 2.5,   // Speed along rail
        turnSpeed: 1.2,   // Rotation speed for keys
        fileUrl: './cloud_web.laz',
        metaUrl: './cloud_web.meta.json'
    };

    // YOUR RECORDED PATH
    let SAVED_PATH = [
        new THREE.Vector3(24.30, -3.32, -5.97),
        new THREE.Vector3(24.44, -3.93, -6.55),
        new THREE.Vector3(23.63, -5.71, -6.65),
        new THREE.Vector3(21.51, -4.81, -6.66),
        new THREE.Vector3(20.81, -4.52, -6.66),
        new THREE.Vector3(20.22, -7.63, -6.50),
        new THREE.Vector3(19.72, -11.16, -6.46),
        new THREE.Vector3(18.81, -14.91, -7.22),
        new THREE.Vector3(18.42, -16.12, -7.21),
        new THREE.Vector3(17.27, -19.00, -7.18),
        new THREE.Vector3(18.13, -20.69, -7.16),
        new THREE.Vector3(18.09, -22.64, -7.83),
        new THREE.Vector3(18.38, -22.36, -7.44),
        new THREE.Vector3(13.64, -22.49, -6.71),
        new THREE.Vector3(9.81, -22.42, -5.84),
        new THREE.Vector3(5.20, -22.46, -5.49),
        new THREE.Vector3(4.33, -22.57, -5.96),
        new THREE.Vector3(2.98, -21.57, -4.82),
        new THREE.Vector3(1.06, -19.60, -4.44),
        new THREE.Vector3(1.20, -18.74, -4.41),
        new THREE.Vector3(1.36, -17.62, -3.43),
        new THREE.Vector3(2.89, -15.20, -2.97),
        new THREE.Vector3(3.36, -14.56, -2.75),
        new THREE.Vector3(5.14, -12.44, -2.35),
        new THREE.Vector3(7.38, -9.85, -2.06),
        new THREE.Vector3(8.70, -8.28, -1.76),
        new THREE.Vector3(8.17, -7.58, -1.63),
        new THREE.Vector3(7.39, -6.68, -1.79),
        new THREE.Vector3(6.45, -5.82, -1.63),
        new THREE.Vector3(5.68, -5.41, -1.55),
        new THREE.Vector3(4.06, -6.23, -1.70),
        new THREE.Vector3(1.54, -4.95, -1.57),
        new THREE.Vector3(-1.13, -2.91, -1.33),
        new THREE.Vector3(-1.72, -2.48, -1.74),
        new THREE.Vector3(-3.87, -0.60, -2.12),
        new THREE.Vector3(-5.35, 0.73, -2.10),
        new THREE.Vector3(-7.65, 2.79, -2.15),
        new THREE.Vector3(-6.50, 5.06, -2.24),
        new THREE.Vector3(-4.54, 9.00, -1.79),
        new THREE.Vector3(-4.09, 9.65, -2.72),
        new THREE.Vector3(-3.05, 12.21, -2.43),
        new THREE.Vector3(-2.16, 14.04, -2.22),
        new THREE.Vector3(-3.77, 15.26, -2.51),
        new THREE.Vector3(-6.84, 16.57, -2.36),
        new THREE.Vector3(-7.97, 16.62, -1.97),
        new THREE.Vector3(-10.63, 16.76, -1.95),
        new THREE.Vector3(-12.76, 14.49, -2.21),
        new THREE.Vector3(-14.00, 13.36, -1.74),
        new THREE.Vector3(-16.88, 10.71, -1.20),
        new THREE.Vector3(-18.65, 11.89, -1.03),
        new THREE.Vector3(-21.00, 13.71, -0.58),
        new THREE.Vector3(-22.38, 14.82, -0.45),
        new THREE.Vector3(-24.24, 16.36, 0.61),
        new THREE.Vector3(-25.74, 17.57, 1.02),
        new THREE.Vector3(-26.48, 18.34, 1.11),
        new THREE.Vector3(-26.47, 19.41, 1.23),
        new THREE.Vector3(-26.04, 23.36, 1.16),
        new THREE.Vector3(-25.79, 24.83, 0.86),
        new THREE.Vector3(-25.72, 25.83, 0.64),
    ];

    // =========================================================================

    // Reverse path if we are starting at the "End"
    const startDist = SETTINGS.startPos.distanceTo(SAVED_PATH[0]);
    const endDist = SETTINGS.startPos.distanceTo(SAVED_PATH[SAVED_PATH.length-1]);
    
    if(endDist < startDist) {
        SAVED_PATH.reverse();
    }

    // VARIABLES
    let moveF=false, moveB=false, turnL=false, turnR=false;
    let railProgress = 0; // 0.0 to 1.0
    let railCurve = null;
    let totalRailLength = 0;
    let prevTime = performance.now();
    let centerOffset = new THREE.Vector3();

    // DOM
    const uiBar = document.getElementById('progress-bar');
    const hud = document.getElementById('hud');

    // SCENE
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x05070a);
    scene.fog = new THREE.FogExp2(0x05070a, 0.015); 

    const camera = new THREE.PerspectiveCamera(65, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.getElementById('app').appendChild(renderer.domElement);

    // CONTROLS
    const controls = new PointerLockControls(camera, document.body);
    const startBtn = document.getElementById('startBtn');
    const overlay = document.getElementById('overlay');

    startBtn.addEventListener('click', () => controls.lock());
    controls.addEventListener('lock', () => {
        overlay.style.opacity = '0';
        hud.style.opacity = '1';
    });
    controls.addEventListener('unlock', () => {
        overlay.style.opacity = '1';
        hud.style.opacity = '0';
    });

    // INIT PATH
    railCurve = new THREE.CatmullRomCurve3(SAVED_PATH);
    railCurve.curveType = 'centripetal'; 
    railCurve.tension = 0.5;
    totalRailLength = railCurve.getLength();

    // Set Initial Position
    const p0 = railCurve.getPointAt(0);
    camera.position.copy(p0);
    camera.lookAt(SETTINGS.startLookAt);

    // INPUTS
    const onKey = (e, active) => {
        switch(e.code) {
            case 'KeyW': 
            case 'ArrowUp':
                moveF = active; break;
            case 'KeyS': 
            case 'ArrowDown':
                moveB = active; break;
            
            // KEYBOARD ROTATION
            case 'KeyA':
            case 'ArrowLeft':
                turnL = active; break;
            case 'KeyD':
            case 'ArrowRight':
                turnR = active; break;
        }
    };
    document.addEventListener('keydown', (e) => onKey(e, true));
    document.addEventListener('keyup', (e) => onKey(e, false));

    // LOADER
    async function init() {
        try {
            try {
                const mRes = await fetch(SETTINGS.metaUrl);
                const meta = await mRes.json();
                if(meta.origin) centerOffset.set(meta.origin[0], meta.origin[1], meta.origin[2]);
            } catch(e){}

            const data = await load(SETTINGS.fileUrl, LASLoader);
            const posAttr = data.attributes['POSITION']?.value || data.attributes['POSITION0']?.value;
            const colAttr = data.attributes['COLOR_0']?.value || data.attributes['RGB']?.value;
            const intAttr = data.attributes['intensity']?.value;

            const positions = new Float32Array(posAttr.length);
            for(let i=0; i<posAttr.length; i+=3) {
                positions[i] = posAttr[i] - centerOffset.x;
                positions[i+1] = posAttr[i+1] - centerOffset.y;
                positions[i+2] = posAttr[i+2] - centerOffset.z;
            }
            
            let colors = null;
            if(colAttr) {
                colors = new Float32Array(posAttr.length);
                const maxVal = (colAttr instanceof Uint8Array) ? 255 : (colAttr instanceof Uint16Array) ? 65535 : 1;
                const stride = (colAttr.length === posAttr.length) ? 3 : 4;
                for(let i=0, j=0; i<colors.length; i+=3, j+=stride) {
                    colors[i]   = colAttr[j] / maxVal;
                    colors[i+1] = colAttr[j+1] / maxVal;
                    colors[i+2] = colAttr[j+2] / maxVal;
                }
            } else if(intAttr) {
                 colors = new Float32Array(posAttr.length);
                 for(let i=0; i<posAttr.length; i+=3) {
                    const v = Math.min(intAttr[i/3]/65535*5, 1);
                    colors[i]=v; colors[i+1]=v; colors[i+2]=v;
                 }
            }

            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            if(colors) geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            geometry.computeBoundingBox();

            const material = new THREE.PointsMaterial({ 
                size: 0.1, 
                vertexColors: !!colors, 
                color: 0xffffff,
            });

            const points = new THREE.Points(geometry, material);
            scene.add(points);

        } catch(err) {
            console.error("Error loading cloud:", err);
        }
    }

    // ANIMATION LOOP
    function animate() {
        requestAnimationFrame(animate);

        const time = performance.now();
        const delta = (time - prevTime) / 1000;
        prevTime = time;

        if (controls.isLocked) {
            
            // 1. POSITION (Rail System)
            const progressStep = (SETTINGS.walkSpeed * delta) / totalRailLength;

            if (moveF) railProgress += progressStep;
            if (moveB) railProgress -= progressStep;
            railProgress = Math.max(0, Math.min(1, railProgress));

            const targetPos = railCurve.getPointAt(railProgress);
            camera.position.copy(targetPos);
            
            // 2. ROTATION (Keys)
            // PointerLockControls usually handles mouse, but we can manually add rotation to the object it controls
            if (turnL) controls.getObject().rotation.y += SETTINGS.turnSpeed * delta;
            if (turnR) controls.getObject().rotation.y -= SETTINGS.turnSpeed * delta;

            // 3. UI
            uiBar.style.width = (railProgress * 100) + '%';
        }

        renderer.render(scene, camera);
    }

    init();
    animate();

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>